---
title: "Practica 2," 
output:
  html_document:
    df_print: paged
  pdf_document: default
  html_notebook: default
---

```{r}
if(!require(RCurl)){
  install.packages('RCurl',dependencies =c("Depends","Imports"),repos='http://cran.es.r-project.org')
  require(RCurl)
}

if(!require(data.table)){
  install.packages('data.table',dependencies =c("Depends","Imports"),repos='http://cran.es.r-project.org')
  require(data.table)
}

if(!require(tidyr)){
  install.packages('tidyr',dependencies =c("Depends","Imports"),repos='http://cran.es.r-project.org')
  require(tidyr)
}

if(!require(ggplot2)){
  install.packages('ggplot2',dependencies =c("Depends","Imports"),repos='http://cran.es.r-project.org')
  require(ggplot2)
}

if(!require(stringr)){
  install.packages('stringr',dependencies =c("Depends","Imports"),repos='http://cran.es.r-project.org')
  require(stringr)
}

```



### Descripcion del dataset

&emsp; En esta practica utilizaremos el dataset que obtuvimos en la Practica 1, “Precio de los carburantes por estación de servicio en España”. 
  
&emsp; El dataset incluye datos de precios de los diferentes carburantes para cada una de las estaciones de servicios localizadas en España. También incluye información detallada sobre cada una de las gasolineras con el fin de que estas puedan ser localizadas fácilmente por el usuario final.


&emsp; El dataset se puede encontrar en el repositorio de Github creado para la Practica 1 (https://github.com/icuevort/web_scraping_gas_prices). A continuacion cargarmos los datos desde Github.


```{r carga}
library(RCurl)
x <- getURL("https://raw.githubusercontent.com/icuevort/web_scraping_gas_prices/main/dataset/Gasolineras.csv")
gasdata<- read.csv(text = x)
head(gasdata)
```


Los datos se han cargado correctamente. Para explorar los datos en mas detalle, utilizamos ahora la funcion str. 

```{r 1}
str(gasdata)
```


Tenemos 12 variables, 10 de ellas son del tipo Character, y dos de ellas (latitud y longitud) son numericas.



### Limpieza de datos


La variable precios incluye ,para cada estacion de servicio, los combustibles disponibles, y su precio. Para que estos datos sean utliles durante nuestro analisis, queremos crear nuevas columnas, una por cada tipo de carburante, que nos den el precio para cada gasolinera. 


El primer paso sera crear una nueva columna con el indice, y despues crear una nueva tabla con solo 2 variables: index y precios
```{r 2}
gasdata$index<- 1:nrow(gasdata)
preciosnew<-gasdata[,c("index","precios")]
head(preciosnew)
```

A continuacion realizamos algunas tareas de limpieza sobre la variable precio, que nos ayudaran a separarla posteriormente.
```{r 3}
library(stringr)
preciosnew$precios<-gsub ('.$','',sub('.',"",preciosnew$precios)) ## Eliminamos el primer y ultimo caracter
preciosnew$precios<-gsub ('Gasóleo ','Gasóleo_',preciosnew$precios) # Sustituimos el espacio en blanco para el tipo gasoleo
preciosnew$precios<-gsub ('Gas N. Compr','Gas_N._Compr',preciosnew$precios) # Sustituimos el espacio en blanco para el tipo gas
preciosnew$precios<-gsub ('Gas N. Licuado','Gas_N._Licuado',preciosnew$precios)
head(preciosnew$precios)
```

Hay 9 tipos de carburantes, asi que separaremos la columna precios en 8 nuevas columnas. Cada una de ellas incluira el tipo de carburante y el precio
```{r 4}
preciosnew[c('1','2','3','4','5','6','7','8','9')]<- str_split_fixed(preciosnew$precios,"', '",9)
head(preciosnew[c('1','2','3','4','5','6','7','8','9')])

```

Seguidamente moveremos cada uno de las nuevas columnas a filas, manteniendo los valores de index y precio. De esta manera tendremos una fila por cada estacion de servicio y carburante disponible.
```{r 5}
library(data.table)
gas_long <- melt(setDT(preciosnew), id.vars = c("index","precios"), variable.name = "gas")
gas_long$value<-gsub("'",'',gas_long$value) #Eliminamos el caracter '
head(gas_long)
```

Como no todas las gasolineras disponen de todos los productos, muchas filas en la columna value estan vacias. A continuacion eliminamos dichas filas
```{r 6}
gas_long<- gas_long [!(gas_long$value=="")]
```
Ahora separamos la columna value en dos nuevas columnas: tipo de carburante y precio. 

```{r 7}
library(tidyr)
gas_long<- separate(gas_long,value,c("tipo","precio")," ",remove=FALSE)
gas_long<-gas_long[,c("index","tipo","precio")]
head(gas_long)
```

Antes de continuar, tenemos que cambiar el tipo de la variable precio a numeric.
```{r 8}
gas_long$precio<-gsub (',','.',gas_long$precio) 
gas_long <- type.convert(gas_long,as.is=TRUE)
head(gas_long)
```


Creamos nuevas columnas, cada una para un tipo de carburante, y como valor el precio de cada combustible.
```{r 9}
gas_long<- spread(gas_long, tipo, precio)
head(gas_long)
```

Finalmente unimos la tabla inicial con esta ultima.
```{r 10}
new_gasdata<- merge(gasdata,gas_long,by.x="index",by.y="index",all=TRUE)
head(new_gasdata)
```


Como no necesitamos la columna de precios, la quitamos de la tabla.Tambien cambiaremos el nombre de alguna de las nuevas columnas, ya que los simbolos incluidos pueden darnos problemas posteriormente
```{r 11}
new_gasdata<-subset(new_gasdata,select=-c(precios))
colnames(new_gasdata)[which (names(new_gasdata)== "SP-98")]<- "Super_98"
colnames(new_gasdata)[which (names(new_gasdata)== "SP-95")]<- "Super_95"
colnames(new_gasdata)[which (names(new_gasdata)== "G-A")]<- "Gasoleo_A"
colnames(new_gasdata)[which (names(new_gasdata)== "G-A+")]<- "Gasoleo_A_Plus"
```

El siguiente paso sera la limpieza de cada uno de los datos. Veamos los datos estadisticos basicos.

```{r 12}
summary(new_gasdata)
```

Veamos con mas detalle las variables relativas a los precios de los carburantes. Todas ellas contienen valores nulos. Esto se esperaba ya que no todos los productos estan disponibles en todas las estaciones de servicio. 

Para ver la distribucion de cada una, y encontrar posibles valores extremos, generamos un grafico de densidad y un diagrama de caja para cada una de ellas.


```{r 13}
library(ggplot2)
for (i in 13:22){
  print(ggplot(new_gasdata, aes(x =new_gasdata[,i]))+geom_density()+xlab(colnames(new_gasdata[i])))
  boxplot(new_gasdata$i,main=colnames(new_gasdata[i]), col="gray")
}

```


Todos los diagramas de cajas nos indican que no hay valores extremos en nuestros datos. Los graficos de densidad nos indican que en general casi todos los precios se distribuyen normalmente, con alguna distribuciones bimodales para los carburantes menos comunes (gas natural comprimido, gas natural licuado, biodiesel).
```{r 14}
for (i in 13:22){
  print(ggplot(new_gasdata, aes(x =new_gasdata[,i]))+geom_density()+xlab(colnames(new_gasdata[i])))
  print(ggplot(new_gasdata, aes(x =new_gasdata[,i]))+geom_density(aes(color=provincia))+xlab(colnames(new_gasdata[i])))

}
```

Ahora limpiaremos los valores de la variable latitud y longitud. Empezamos por solucionar los valores *NA*, como se trata solo de 4 instancias buscamos los valores de latitud y longitud de la gasolinera en internet para sustituir manualmente *Na* por el valor real.

```{r 15}
new_gasdata[is.na(new_gasdata$latitud) | is.na(new_gasdata$longitud),]
```
```{r 16}
new_gasdata[1916, "latitud"] <- 41.352744 
new_gasdata[1916, "longitud"] <- 2.144251

new_gasdata[9882, "latitud"] <- 37.370488
new_gasdata[9882, "longitud"] <- -6.026994 

new_gasdata[11376, "latitud"] <- 41.647816 
new_gasdata[11376, "longitud"] <- -4.717498 

new_gasdata[11601, "latitud"] <- 42.035458
new_gasdata[11601, "longitud"] <- -5.747123

summary(new_gasdata$latitud)
summary(new_gasdata$longitud)
```
Una vez solucionados los valores *Na* procedemos a comprobar la existencia de *outliers*.

```{r 17}
boxplot(new_gasdata$latitud, main="latitud")
summary(new_gasdata$latitud)
```

Observando los *outliers* de la latitud, los puntos en torno a 30 son correctos ya que pertenecen a las gasolineras de canarias, las cuales tienen latitudes cercanas a 30. El problema está en las latitudes inferiores a 0. Vamos a comprobar las instancias con estos valores.

```{r 18}
new_gasdata[new_gasdata$latitud < 10,]
```
Se puede ver que los datos de latitud y longitud están invertidos, así que procedemos a insertar los valores correctos.

```{r 19}
lat <- new_gasdata[5762, "longitud"]
long <- new_gasdata[5762, "latitud"]

new_gasdata[5762, "longitud"] <- long
new_gasdata[5762, "latitud"] <- lat

lat <- new_gasdata[7275, "longitud"]
long <- new_gasdata[7275, "latitud"]

new_gasdata[7275, "longitud"] <- long
new_gasdata[7275, "latitud"] <- lat

new_gasdata[c(5762, 7275),]
```

Una vez solucionados los problemas con los *outliers* de la latitud vamos a ver los *outliers* de la longitud.

```{r 20}
boxplot(new_gasdata$longitud, main="longitud")
summary(new_gasdata$longitud)
```

Aunque tenemos *outliers* inferiores, los datos están dentro del rango aceptable. Estos outliers cercanos a -18 se deben a las islas canarias.

Ya hemos limpiado todos los datos numéricos, así que ahora pasaremos a limpiar los datos cualitativos.

Comenzamos con la variable provincia. Comprobamos si el número de provincias es el correcto y si los nombres son los correctos.

```{r 21}
unique(new_gasdata$provincia)
```
El número de provincias es correcto, pero parece que hay tres provincias con el nombre incorrecto.

```{r 22}
head(new_gasdata[new_gasdata$provincia == "A",], 3)
head(new_gasdata[new_gasdata$provincia == "LA",], 3)
head(new_gasdata[new_gasdata$provincia == "LAS",], 3)
```
Parece que parte del nombre se ha quedado en la variable localidad, así que damos los valores pertinentes a las provincias y eliminamos de localidad la parte correspondiente a la provincia.

```{r 23}
new_gasdata[new_gasdata$provincia == "A", "localidad"] <- gsub(" [(]CORUÑA", "", new_gasdata[new_gasdata$provincia == "A", "localidad"])
new_gasdata[new_gasdata$provincia == "LA", "localidad"] <- gsub(" [(]RIOJA", "", new_gasdata[new_gasdata$provincia == "LA", "localidad"])
new_gasdata[new_gasdata$provincia == "LAS", "localidad"] <- gsub(" [(]PALMAS", "", new_gasdata[new_gasdata$provincia == "LAS", "localidad"])

new_gasdata[new_gasdata$provincia == "A", "provincia"] <- "A CORUÑA"
new_gasdata[new_gasdata$provincia == "LA", "provincia"] <- "LA RIOJA"
new_gasdata[new_gasdata$provincia == "LAS", "provincia"] <- "LAS PALMAS"

unique(new_gasdata$provincia)
```

Corregidos los valores de las provincias pasaremos a comprobar si existe algún valor vacío en la variable localidad y en la variable dirección.

```{r 24}
new_gasdata[new_gasdata$localidad == "",]
new_gasdata[new_gasdata$direccion == "",]
```
No existen valores vacíos así que damos ambas variables por buenas. Pasamos entonces a comprobar si las variables margen, horario, empresa, fechaRevision, fechaUltima y ventaPublico son correctas. Para ello, comprobaremos los valores únicos de margen, fechaRevision y fechaUltima. Mientras que veremos si existe algún valor vacío en horario, empresa y ventaPublico.

```{r 25}
unique(new_gasdata$margen)
unique(new_gasdata$fechaRevision)
unique(new_gasdata$fechaUltima)

new_gasdata[new_gasdata$horario == "",]
new_gasdata[new_gasdata$empresa == "",]
new_gasdata[new_gasdata$ventaPublico == "",]
```
Todos los datos parecen correctos, así que no es necesaria una limpieza de estos.


