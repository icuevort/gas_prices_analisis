---
title: "Practica 2," 
output:
  html_document:
    toc: yes
    toc_depth: 5
    df_print: paged
  html_notebook: default
  pdf_document: default
  word_document: default
---

```{r}
if(!require(RCurl)){
  install.packages('RCurl',dependencies =c("Depends","Imports"),repos='http://cran.es.r-project.org')
  require(RCurl)
}

if(!require(data.table)){
  install.packages('data.table',dependencies =c("Depends","Imports"),repos='http://cran.es.r-project.org')
  require(data.table)
}

if(!require(tidyr)){
  install.packages('tidyr',dependencies =c("Depends","Imports"),repos='http://cran.es.r-project.org')
  require(tidyr)
}

if(!require(ggplot2)){
  install.packages('ggplot2',dependencies =c("Depends","Imports"),repos='http://cran.es.r-project.org')
  require(ggplot2)
}

if(!require(stringr)){
  install.packages('stringr',dependencies =c("Depends","Imports"),repos='http://cran.es.r-project.org')
  require(stringr)
}

if(!require(funModeling)){
  install.packages('funModeling',dependencies =c("Depends","Imports"),repos='http://cran.es.r-project.org')
  require(funModeling)
}

if(!require(Hmisc)){install.packages('Hmisc',dependencies =c("Depends","Imports"),repos='http://cran.es.r-project.org')
  require(Hmisc)
}

if(!require(plyr)){install.packages('plyr',dependencies =c("Depends","Imports"),repos='http://cran.es.r-project.org')
  require(plyr)
}

if(!require(car)){install.packages('car',dependencies =c("Depends","Imports"),repos='http://cran.es.r-project.org')
  require(car)
}
if(!require(ggpubr)){install.packages('ggpubr',dependencies =c("Depends","Imports"),repos='http://cran.es.r-project.org')
  require(ggpubr)
}
```



## 1. Descripcion del dataset

&emsp; En esta practica utilizaremos el dataset que obtuvimos en la Practica 1, “Precio de los carburantes por estación de servicio en España”. 
  
&emsp; El dataset incluye datos de precios de los diferentes carburantes para cada una de las estaciones de servicios localizadas en España. También incluye información detallada sobre cada una de las gasolineras con el fin de que estas puedan ser localizadas fácilmente por el usuario final.


&emsp; El dataset se puede encontrar en el repositorio de Github creado para la Practica 1 (https://github.com/icuevort/web_scraping_gas_prices). A continuacion cargarmos los datos desde Github.


```{r carga}
library(RCurl)
x <- getURL("https://raw.githubusercontent.com/icuevort/web_scraping_gas_prices/main/dataset/Gasolineras.csv")
gasdata<- read.csv(text = x)
head(gasdata)
```


Los datos se han cargado correctamente. Para explorar los datos en mas detalle, utilizamos ahora la funcion str. 

```{r 1}
str(gasdata)
```


Tenemos 12 variables, 10 de ellas son del tipo Character, y dos de ellas (latitud y longitud) son numericas.



## 2. Limpieza de datos

### 2.1 Restructuracion de la variable precios

La variable precios incluye ,para cada estacion de servicio, los combustibles disponibles, y su precio. Para que estos datos sean utliles durante nuestro analisis, queremos crear nuevas columnas, una por cada tipo de carburante, que nos den el precio para cada gasolinera. 


El primer paso sera crear una nueva columna con el indice, y despues crear una nueva tabla con solo 2 variables: index y precios
```{r 2}
gasdata$index<- 1:nrow(gasdata)
preciosnew<-gasdata[,c("index","precios")]
head(preciosnew)
```

A continuacion realizamos algunas tareas de limpieza sobre la variable precio, que nos ayudaran a separarla posteriormente.
```{r 3}
library(stringr)
preciosnew$precios<-gsub ('.$','',sub('.',"",preciosnew$precios)) ## Eliminamos el primer y ultimo caracter
preciosnew$precios<-gsub ('Gasóleo ','Gasóleo_',preciosnew$precios) # Sustituimos el espacio en blanco para el tipo gasoleo
preciosnew$precios<-gsub ('Gas N. Compr','Gas_N._Compr',preciosnew$precios) # Sustituimos el espacio en blanco para el tipo gas
preciosnew$precios<-gsub ('Gas N. Licuado','Gas_N._Licuado',preciosnew$precios)
head(preciosnew$precios)
```

Hay 9 tipos de carburantes, asi que separaremos la columna precios en 8 nuevas columnas. Cada una de ellas incluira el tipo de carburante y el precio
```{r 4}
preciosnew[c('1','2','3','4','5','6','7','8','9')]<- str_split_fixed(preciosnew$precios,"', '",9)
head(preciosnew[c('1','2','3','4','5','6','7','8','9')])

```

Seguidamente moveremos cada uno de las nuevas columnas a filas, manteniendo los valores de index y precio. De esta manera tendremos una fila por cada estacion de servicio y carburante disponible.
```{r 5}
library(data.table)
gas_long <- melt(setDT(preciosnew), id.vars = c("index","precios"), variable.name = "gas")
gas_long$value<-gsub("'",'',gas_long$value) #Eliminamos el caracter '
head(gas_long)
```

Como no todas las gasolineras disponen de todos los productos, muchas filas en la columna value estan vacias. A continuacion eliminamos dichas filas
```{r 6}
gas_long<- gas_long [!(gas_long$value=="")]
```
Ahora separamos la columna value en dos nuevas columnas: tipo de carburante y precio. 

```{r 7}
library(tidyr)
gas_long<- separate(gas_long,value,c("tipo","precio")," ",remove=FALSE)
gas_long<-gas_long[,c("index","tipo","precio")]
head(gas_long)
```

Antes de continuar, tenemos que cambiar el tipo de la variable precio a numeric.
```{r 8}
gas_long$precio<-gsub (',','.',gas_long$precio) 
gas_long <- type.convert(gas_long,as.is=TRUE)
head(gas_long)
```


Creamos nuevas columnas, cada una para un tipo de carburante, y como valor el precio de cada combustible.
```{r 9}
gas_long<- spread(gas_long, tipo, precio)
head(gas_long)
```

Finalmente unimos la tabla inicial con esta ultima.
```{r 10}
new_gasdata<- merge(gasdata,gas_long,by.x="index",by.y="index",all=TRUE)
head(new_gasdata)
```


Como no necesitamos la columna de precios, la quitamos de la tabla.Tambien cambiaremos el nombre de alguna de las nuevas columnas, ya que los simbolos incluidos pueden darnos problemas posteriormente
```{r 11}
new_gasdata<-subset(new_gasdata,select=-c(precios))
colnames(new_gasdata)[which (names(new_gasdata)== "SP-98")]<- "Super_98"
colnames(new_gasdata)[which (names(new_gasdata)== "SP-95")]<- "Super_95"
colnames(new_gasdata)[which (names(new_gasdata)== "G-A")]<- "Gasoleo_A"
colnames(new_gasdata)[which (names(new_gasdata)== "G-A+")]<- "Gasoleo_A_Plus"
```

### 2.2 Datos estadisticos basicos

El siguiente paso sera la limpieza de cada uno de los datos. Veamos los datos estadisticos basicos.

```{r 12}
summary(new_gasdata)
```

### 2.3 Variables relativas al precio

Veamos con mas detalle las variables relativas a los precios de los carburantes. Todas ellas contienen valores nulos. Esto se esperaba ya que no todos los productos estan disponibles en todas las estaciones de servicio. 

Para ver la distribucion de cada una, y encontrar posibles valores extremos, generamos un grafico de densidad y un diagrama de caja para cada una de ellas.


```{r 13}
library(ggplot2)
for (i in 13:22){
  print(ggplot(new_gasdata, aes(x =new_gasdata[,i]))+geom_density()+xlab(colnames(new_gasdata[i])))
  boxplot(new_gasdata$i,main=colnames(new_gasdata[i]), col="gray")
}

```


Todos los diagramas de cajas nos indican que no hay valores extremos en nuestros datos. Los graficos de densidad nos indican que en general casi todos los precios se distribuyen normalmente, con alguna distribuciones bimodales para los carburantes menos comunes (gas natural comprimido, gas natural licuado, biodiesel).



### 2.4 Variables latitud y longitud

Ahora limpiaremos los valores de la variable latitud y longitud. Empezamos por solucionar los valores *NA*, como se trata solo de 4 instancias buscamos los valores de latitud y longitud de la gasolinera en internet para sustituir manualmente *Na* por el valor real.

```{r 15}
new_gasdata[is.na(new_gasdata$latitud) | is.na(new_gasdata$longitud),]
```
```{r 16}
new_gasdata[1916, "latitud"] <- 41.352744 
new_gasdata[1916, "longitud"] <- 2.144251

new_gasdata[9882, "latitud"] <- 37.370488
new_gasdata[9882, "longitud"] <- -6.026994 

new_gasdata[11376, "latitud"] <- 41.647816 
new_gasdata[11376, "longitud"] <- -4.717498 

new_gasdata[11601, "latitud"] <- 42.035458
new_gasdata[11601, "longitud"] <- -5.747123

summary(new_gasdata$latitud)
summary(new_gasdata$longitud)
```
Una vez solucionados los valores *Na* procedemos a comprobar la existencia de *outliers*.

```{r 17}
boxplot(new_gasdata$latitud, main="latitud")
summary(new_gasdata$latitud)
```

Observando los *outliers* de la latitud, los puntos en torno a 30 son correctos ya que pertenecen a las gasolineras de canarias, las cuales tienen latitudes cercanas a 30. El problema está en las latitudes inferiores a 0. Vamos a comprobar las instancias con estos valores.

```{r 18}
new_gasdata[new_gasdata$latitud < 10,]
```
Se puede ver que los datos de latitud y longitud están invertidos, así que procedemos a insertar los valores correctos.

```{r 19}
lat <- new_gasdata[5762, "longitud"]
long <- new_gasdata[5762, "latitud"]

new_gasdata[5762, "longitud"] <- long
new_gasdata[5762, "latitud"] <- lat

lat <- new_gasdata[7275, "longitud"]
long <- new_gasdata[7275, "latitud"]

new_gasdata[7275, "longitud"] <- long
new_gasdata[7275, "latitud"] <- lat

new_gasdata[c(5762, 7275),]
```

Una vez solucionados los problemas con los *outliers* de la latitud vamos a ver los *outliers* de la longitud.

```{r 20}
boxplot(new_gasdata$longitud, main="longitud")
summary(new_gasdata$longitud)
```

Aunque tenemos *outliers* inferiores, los datos están dentro del rango aceptable. Estos outliers cercanos a -18 se deben a las islas canarias.


### 2.5 Variable Provincia

Ya hemos limpiado todos los datos numéricos, así que ahora pasaremos a limpiar los datos cualitativos.

Comenzamos con la variable provincia. Comprobamos si el número de provincias es el correcto y si los nombres son los correctos.

```{r 21}
unique(new_gasdata$provincia)
```
El número de provincias es correcto, pero parece que hay tres provincias con el nombre incorrecto.

```{r 22}
head(new_gasdata[new_gasdata$provincia == "A",], 3)
head(new_gasdata[new_gasdata$provincia == "LA",], 3)
head(new_gasdata[new_gasdata$provincia == "LAS",], 3)
```
Parece que parte del nombre se ha quedado en la variable localidad, así que damos los valores pertinentes a las provincias y eliminamos de localidad la parte correspondiente a la provincia.

```{r 23}
new_gasdata[new_gasdata$provincia == "A", "localidad"] <- gsub(" [(]CORUÑA", "", new_gasdata[new_gasdata$provincia == "A", "localidad"])
new_gasdata[new_gasdata$provincia == "LA", "localidad"] <- gsub(" [(]RIOJA", "", new_gasdata[new_gasdata$provincia == "LA", "localidad"])
new_gasdata[new_gasdata$provincia == "LAS", "localidad"] <- gsub(" [(]PALMAS", "", new_gasdata[new_gasdata$provincia == "LAS", "localidad"])

new_gasdata[new_gasdata$provincia == "A", "provincia"] <- "A CORUÑA"
new_gasdata[new_gasdata$provincia == "LA", "provincia"] <- "LA RIOJA"
new_gasdata[new_gasdata$provincia == "LAS", "provincia"] <- "LAS PALMAS"

unique(new_gasdata$provincia)
```

Corregidos los valores de las provincias pasaremos a comprobar si existe algún valor vacío en la variable localidad y en la variable dirección.

```{r 24}
new_gasdata[new_gasdata$localidad == "",]
new_gasdata[new_gasdata$direccion == "",]
```
No existen valores vacíos así que damos ambas variables por buenas. Pasamos entonces a comprobar si las variables margen, horario, empresa, fechaRevision, fechaUltima y ventaPublico son correctas. Para ello, comprobaremos los valores únicos de margen, fechaRevision y fechaUltima. Mientras que veremos si existe algún valor vacío en horario, empresa y ventaPublico.

```{r 25}
unique(new_gasdata$margen)
unique(new_gasdata$fechaRevision)
unique(new_gasdata$fechaUltima)

new_gasdata[new_gasdata$horario == "",]
new_gasdata[new_gasdata$empresa == "",]
new_gasdata[new_gasdata$ventaPublico == "",]
```
Todos los datos parecen correctos, así que no es necesaria una limpieza de estos.

### 2.6 Variables empresa y ventaPublico

Comenzemos limpiando los datos vacios

```{r}
new_gasdata[new_gasdata$empresa == "",]
new_gasdata[new_gasdata$ventaPublico == "",]
```

El siguiente paso es crear una tabla de frequencias para estas dos variables.

```{r}
freq(new_gasdata$empresa) 
freq(new_gasdata$ventaPublico) 
```

En cuanto a la variable empresa, esta contiene 4027 diferentes valores. La petrolera Repsol gestiona el 23% de todas las gasolineras en el territorio nacional, seguida de Cepsa (11%). 

La variable ventaPublico tiene solo dos posibles valores: "Venta al publico" (92%) y "Cerrada al publico general" (7%). 


## 3. Analisis de los datos

En este apartado vamos a responder a las siguientes preguntas:

* Cuales son las cadenas de gasolineras mas caras?

* Se puede predecir el valor del combustible con los datos que tenemos?

* Existe correlación entre la latitud/longitud con el precio?

* Varían los precios significativamente con latitudes por encima de 40,3093?


### 3.1 Cuales son las cadenas de gasolineras mas caras?

Para responder a esta pregunta vamos a realizar las siguientes consideraciones:

* Analizaremos unicamente el precio del Gasoleo A, que es el que esta disponible en mas gasolineras (11.560 de las 11.909). 
* Solo incluimos estaciones de servicio con venta al publico. 
* Ya que existen mas 4.027 empresas asociadas con estaciones de servicio, compareremos unicamente las 10 cadenas principales, que gestionan algo mas del 50% de todas las gasolineras en el pais (REPSOL, CEPSA, GALP, SHELL, BP, BALLENOIL, PETRONOR, AVIA. CARREFOUR, PLENOIL).

A continuacion creamos el dataset con las condiciones anteriores. Primero obtenemos las 10 empresas con mas gasolineras, y nos quedamos unicamente con las estaciones de servicio de dichas empresas

```{r}
df<- ddply(new_gasdata,~empresa,summarise,N=length(empresa))
setorder(df,cols=-"N")
df<- head(df,10)
top_10<- merge(df,new_gasdata, by="empresa")
unique(top_10$empresa)
```
Ahora eliminamos las gasolineras no abiertas al publico,y reducimos el volumen de datos utilizados seleccionando solo las columnas que pueden ser de utilidad. Tambien eliminamos todos los valores nulos en el precio del gasoleo
```{r}
top_10<- top_10[!(top_10$ventaPublico== "CERRADA AL PUBLICO GENERAL"),]
top_10<-na.omit(top_10[,c("empresa","provincia","Gasoleo_A")])
top_10
```
Antes de continuar con el analisis, comprobemos la normalidad de la variable Gasoleo_A. En primer lugar creamos un diagrama de densidad y un histograma.

```{r}
ggplot(top_10, aes(x = Gasoleo_A))+geom_density() +ggtitle('Gasoleo A')
ggplot(top_10, aes(x = Gasoleo_A))+geom_histogram(binwidth = 0.025)
summary(top_10$Gasoleo_A)
```
Visualmente se comprueba que la variable tiene cola hacia la izquierda. Por otra parte, la tabla resumen nos muestra que la media y la mediana son valores muy cercanos, con lo que la distribucion esta centrada.

Usemos ahora las curva Q-Q, que representa los quantiles de nuestras observaciones frente a una hipotetica distribucion normal. Si la representacion sigue una linea recta, significa que podemos asumir normalidad.

```{r}
qqnorm(top_10$Gasoleo_A)
```
De las representaciones anteriores podemos concluir que la variable Gasoleo_A es normal por encima de 1.8. La cola de la izquierda afecta a la normalidad de la variable, y deberiamos estudiar los valores mas extremos para enterder si son outliers o considerar esas observaciones como una poblacion de estaciones de servicio diferente.


Comprobemos tambien la homogeneidad de varianzas utilizando el test de Levene
```{r}
leveneTest(Gasoleo_A ~ empresa, data=top_10)
```
p<0.05, con lo que 0,05), se rechaza la hipótesis nula de homocedasticidad y se concluye que la variable Gasoleo_A presenta varianzas estadísticamente diferentes para los diferentes grupos de empresa.

Comparemos ahora los precios medios y medianos por empresa. Primero creamos una tabla para ver ambos valores.
```{r}

ddply(top_10,~empresa,summarise,Media=mean(Gasoleo_A), Mediana = median.default(Gasoleo_A))
```
Los diagramas de caja y graficos de densidad nos ayudaran a enterder mejor los datos.
```{r}
ggplot(top_10, aes(x = empresa, y = Gasoleo_A))+ geom_boxplot()+ggtitle('Empresa')
```
```{r}

ggplot(top_10, aes(x = Gasoleo_A))+geom_density(aes(color=empresa)) +ggtitle('Precio del Gasoleo por empresa')+theme(legend.position = "bottom")
```
La primera conclusion que obtenemos es que Plenoil y Ballenoil parecen tener menores precios para el Gasoleo A. 

Para entender si la diferencia de precios es estadisticamente significativa, aplicamos el test ANOVA. En el test ANOVA vamos a comparar las medias de precios de las 10 empresas, y estimar si estas son iguales o no.

- H0: µ1 = µ2 = µ3 = µ4 = µ5 = µ6 = µ7 = µ8 = µ9 = µ10
- H1: Las medias no son iguales.


```{r}
mod1 <- aov(Gasoleo_A ~ empresa, data = top_10)
mod1
summary.lm(mod1)
```

El valor de P<0.05, por lo que rechazamos la hipotesis nula y concluimos que el precio medio por empresa no es igual.

Este resultado solo nos indica que el valor medio para cada empresa no es igual, pero no dice nada sobre que empresas son diferentes entre si. Para ello utilizamos el test the Tukey.

```{r}
TukeyHSD(mod1)
```

Los resultado confirman lo que ya habiamos intuido anteriormente: Plenoil y Ballenoil son mas baratas que las otras 8 empresas. Tambien podemos observar que es Pleanoil es mas barata que Ballenoil (p=0.0112845), con lo que podemos considerarla la cadena mas barata. 
Otros resultados significativos son SHELL-BP (p=0.0000073), SHELL-CARREFOUR (p=0.0000341) y PETRONOR-GALP (p=0.0266629)

Hemos visto que hay una diferencia significativa en las medias. Ahora veamos cual es la capacidad explicativa del modelo. Para ello calcularemos R^2 usando la funcion etaSquared del paquete lsr.

```{r}
library(lsr)
etaSquared(mod1)

```
El resultado, que es la medida de la intensidad de la relacion, nos indica que el modelo explica el 15% de la variabilidad total.

Hemos visto que dos de las cadenas de carburantes son mas baratas que las otras 8. Pero veamos si la provincia tiene influencia en el precio. Lo que queremos averiguar es si los resultados anteriores pueden estar sesgados por la provincia es la que se localizan las estaciones de servicio de cada cadena.

Para simplicar los resultados, compararemos Plenoil, Ballenoil y Repsol.

```{r}
top_3<- top_10[which (top_10$empresa %in% c("PLENOIL","BALLENOIL","REPSOL")),]
```

Tambien seleccionamos solo las provincias que tengan estaciones de servicio de las tres empresas.

```{r}
provincias<- ddply(ddply(top_3,~provincia+empresa,summarise,Media=mean(Gasoleo_A)),~provincia,summarise,empresas=sum(empresa!=""))
provincias<- provincias [provincias$empresas==3,]
top_3<- merge(provincias,top_3, by="provincia")
unique(top_3$provincia)
```

Para ver el posible impacto de la provincia en el precio, creamos una tabla que agrupa los valores medios por provincia y empresa.
```{r}
ddply(top_3,~provincia+empresa,summarise,Media=mean(Gasoleo_A))
```

En esta tabla ya podemos comprobar que en general Ballenoil y Plenoil siguen siendo mas baratas que Repsol. 

Representamos el grafico de perfil para visualizar las diferencias de precio entre empresas por provincia.

```{r}
ggline(top_3, x = "provincia", y = "Gasoleo_A", add = c("mean_se"),color = "empresa", palette = "jco")+theme(axis.text.x = element_text(angle = 90, hjust = 1, size = 8))
```
A continuacion aplicamos el modelo ANoVA de dos factores. Incluimos el termino empresa:provincia ya que queremos entender si existe interaccion entre estas dos variables.
```{r}
mod2 <- aov(Gasoleo_A ~ empresa+provincia+empresa:provincia, data = top_3)
mod2
```
```{r}
summary(mod2)
```
Los resultados nos indican que los tres factores (empresa, provincia y su interaccion) son estadisticamente significativos. Veamos el orden de importancia.
```{r}
etaSquared(mod2)
```
Empresa es el mas significativo, seguido de provincia y de su interaccion.
```{r}
summary.lm(mod2)
```
EL modelo explica el 74% de la variabilidad entre medias.
```{r}
require(DescTools)
ScheffeTest(x=mod2)
```
```{r}
mod3 <- aov(Gasoleo_A ~ empresa+provincia+empresa:provincia, data = top_10)
summary(mod3)
summary.lm(mod3)
```

```{r}
plot(mod3)
```

